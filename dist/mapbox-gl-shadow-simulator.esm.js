/**
 * Copyright Ted Piotrowski 2024
 * Package: mapbox-gl-shadow-simulator
 * Version: 0.54.1-unity
 * For licensing visit: https://shademap.app/about/
 */

function t(t,e,r){var i=e[1],n=e[0],o=i-n;return t===i&&r?t:((t-n)%o+o)%o+n}function e(t,e){if(!1===e)return t;var r=Math.pow(10,void 0===e?6:e);return Math.round(t*r)/r}var r=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)};function i(t,e,r){this.x=r?Math.round(t):t,this.y=r?Math.round(e):e}var n=Math.trunc||function(t){return t>0?Math.floor(t):Math.ceil(t)};function o(t,e,n){return t instanceof i?t:r(t)?new i(t[0],t[1]):null==t?t:"object"==typeof t&&"x"in t&&"y"in t?new i(t.x,t.y):new i(t,e,n)}function a(t,e){if(t)for(var r=e?[t,e]:t,i=0,n=r.length;i<n;i++)this.extend(r[i])}function s(t,e){return!t||t instanceof a?t:new a(t,e)}function u(t,e){if(t)for(var r=e?[t,e]:t,i=0,n=r.length;i<n;i++)this.extend(r[i])}function h(t,e){return t instanceof u?t:new u(t,e)}i.prototype={clone:function(){return new i(this.x,this.y)},add:function(t){return this.clone()._add(o(t))},_add:function(t){return this.x+=t.x,this.y+=t.y,this},subtract:function(t){return this.clone()._subtract(o(t))},_subtract:function(t){return this.x-=t.x,this.y-=t.y,this},divideBy:function(t){return this.clone()._divideBy(t)},_divideBy:function(t){return this.x/=t,this.y/=t,this},multiplyBy:function(t){return this.clone()._multiplyBy(t)},_multiplyBy:function(t){return this.x*=t,this.y*=t,this},scaleBy:function(t){return new i(this.x*t.x,this.y*t.y)},unscaleBy:function(t){return new i(this.x/t.x,this.y/t.y)},round:function(){return this.clone()._round()},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},floor:function(){return this.clone()._floor()},_floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this},ceil:function(){return this.clone()._ceil()},_ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this},trunc:function(){return this.clone()._trunc()},_trunc:function(){return this.x=n(this.x),this.y=n(this.y),this},distanceTo:function(t){var e=(t=o(t)).x-this.x,r=t.y-this.y;return Math.sqrt(e*e+r*r)},equals:function(t){return(t=o(t)).x===this.x&&t.y===this.y},contains:function(t){return t=o(t),Math.abs(t.x)<=Math.abs(this.x)&&Math.abs(t.y)<=Math.abs(this.y)},toString:function(){return"Point("+e(this.x)+", "+e(this.y)+")"}},a.prototype={extend:function(t){var e,r;if(!t)return this;if(t instanceof i||"number"==typeof t[0]||"x"in t)e=r=o(t);else if(e=(t=s(t)).min,r=t.max,!e||!r)return this;return this.min||this.max?(this.min.x=Math.min(e.x,this.min.x),this.max.x=Math.max(r.x,this.max.x),this.min.y=Math.min(e.y,this.min.y),this.max.y=Math.max(r.y,this.max.y)):(this.min=e.clone(),this.max=r.clone()),this},getCenter:function(t){return o((this.min.x+this.max.x)/2,(this.min.y+this.max.y)/2,t)},getBottomLeft:function(){return o(this.min.x,this.max.y)},getTopRight:function(){return o(this.max.x,this.min.y)},getTopLeft:function(){return this.min},getBottomRight:function(){return this.max},getSize:function(){return this.max.subtract(this.min)},contains:function(t){var e,r;return(t="number"==typeof t[0]||t instanceof i?o(t):s(t))instanceof a?(e=t.min,r=t.max):e=r=t,e.x>=this.min.x&&r.x<=this.max.x&&e.y>=this.min.y&&r.y<=this.max.y},intersects:function(t){t=s(t);var e=this.min,r=this.max,i=t.min,n=t.max,o=n.x>=e.x&&i.x<=r.x,a=n.y>=e.y&&i.y<=r.y;return o&&a},overlaps:function(t){t=s(t);var e=this.min,r=this.max,i=t.min,n=t.max,o=n.x>e.x&&i.x<r.x,a=n.y>e.y&&i.y<r.y;return o&&a},isValid:function(){return!(!this.min||!this.max)},pad:function(t){var e=this.min,r=this.max,i=Math.abs(e.x-r.x)*t,n=Math.abs(e.y-r.y)*t;return s(o(e.x-i,e.y-n),o(r.x+i,r.y+n))},equals:function(t){return!!t&&(t=s(t),this.min.equals(t.getTopLeft())&&this.max.equals(t.getBottomRight()))}},u.prototype={extend:function(t){var e,r,i=this._southWest,n=this._northEast;if(t instanceof c)e=t,r=t;else{if(!(t instanceof u))return t?this.extend(f(t)||h(t)):this;if(e=t._southWest,r=t._northEast,!e||!r)return this}return i||n?(i.lat=Math.min(e.lat,i.lat),i.lng=Math.min(e.lng,i.lng),n.lat=Math.max(r.lat,n.lat),n.lng=Math.max(r.lng,n.lng)):(this._southWest=new c(e.lat,e.lng),this._northEast=new c(r.lat,r.lng)),this},pad:function(t){var e=this._southWest,r=this._northEast,i=Math.abs(e.lat-r.lat)*t,n=Math.abs(e.lng-r.lng)*t;return new u(new c(e.lat-i,e.lng-n),new c(r.lat+i,r.lng+n))},getCenter:function(){return new c((this._southWest.lat+this._northEast.lat)/2,(this._southWest.lng+this._northEast.lng)/2)},getSouthWest:function(){return this._southWest},getNorthEast:function(){return this._northEast},getNorthWest:function(){return new c(this.getNorth(),this.getWest())},getSouthEast:function(){return new c(this.getSouth(),this.getEast())},getWest:function(){return this._southWest.lng},getSouth:function(){return this._southWest.lat},getEast:function(){return this._northEast.lng},getNorth:function(){return this._northEast.lat},contains:function(t){t="number"==typeof t[0]||t instanceof c||"lat"in t?f(t):h(t);var e,r,i=this._southWest,n=this._northEast;return t instanceof u?(e=t.getSouthWest(),r=t.getNorthEast()):e=r=t,e.lat>=i.lat&&r.lat<=n.lat&&e.lng>=i.lng&&r.lng<=n.lng},intersects:function(t){t=h(t);var e=this._southWest,r=this._northEast,i=t.getSouthWest(),n=t.getNorthEast(),o=n.lat>=e.lat&&i.lat<=r.lat,a=n.lng>=e.lng&&i.lng<=r.lng;return o&&a},overlaps:function(t){t=h(t);var e=this._southWest,r=this._northEast,i=t.getSouthWest(),n=t.getNorthEast(),o=n.lat>e.lat&&i.lat<r.lat,a=n.lng>e.lng&&i.lng<r.lng;return o&&a},toBBoxString:function(){return[this.getWest(),this.getSouth(),this.getEast(),this.getNorth()].join(",")},equals:function(t,e){return!!t&&(t=h(t),this._southWest.equals(t.getSouthWest(),e)&&this._northEast.equals(t.getNorthEast(),e))},isValid:function(){return!(!this._southWest||!this._northEast)}};var l=function(t){var e,r,i,n;for(r=1,i=arguments.length;r<i;r++)for(e in n=arguments[r])t[e]=n[e];return t}({},{latLngToPoint:function(t,e){var r=this.projection.project(t),i=this.scale(e);return this.transformation._transform(r,i)},pointToLatLng:function(t,e){var r=this.scale(e),i=this.transformation.untransform(t,r);return this.projection.unproject(i)},project:function(t){return this.projection.project(t)},unproject:function(t){return this.projection.unproject(t)},scale:function(t){return 256*Math.pow(2,t)},zoom:function(t){return Math.log(t/256)/Math.LN2},getProjectedBounds:function(t){if(this.infinite)return null;var e=this.projection.bounds,r=this.scale(t);return new a(this.transformation.transform(e.min,r),this.transformation.transform(e.max,r))},infinite:!1,wrapLatLng:function(e){var r=this.wrapLng?t(e.lng,this.wrapLng,!0):e.lng;return new c(this.wrapLat?t(e.lat,this.wrapLat,!0):e.lat,r,e.alt)},wrapLatLngBounds:function(t){var e=t.getCenter(),r=this.wrapLatLng(e),i=e.lat-r.lat,n=e.lng-r.lng;if(0===i&&0===n)return t;var o=t.getSouthWest(),a=t.getNorthEast();return new u(new c(o.lat-i,o.lng-n),new c(a.lat-i,a.lng-n))}},{wrapLng:[-180,180],R:6371e3,distance:function(t,e){var r=Math.PI/180,i=t.lat*r,n=e.lat*r,o=Math.sin((e.lat-t.lat)*r/2),a=Math.sin((e.lng-t.lng)*r/2),s=o*o+Math.cos(i)*Math.cos(n)*a*a,u=2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s));return this.R*u}});function c(t,e,r){if(isNaN(t)||isNaN(e))throw new Error("Invalid LatLng object: ("+t+", "+e+")");this.lat=+t,this.lng=+e,void 0!==r&&(this.alt=+r)}function f(t,e,i){return t instanceof c?t:r(t)&&"object"!=typeof t[0]?3===t.length?new c(t[0],t[1],t[2]):2===t.length?new c(t[0],t[1]):null:null==t?t:"object"==typeof t&&"lat"in t?new c(t.lat,"lng"in t?t.lng:t.lon,t.alt):void 0===e?null:new c(t,e,i)}c.prototype={equals:function(t,e){return!!t&&(t=f(t),Math.max(Math.abs(this.lat-t.lat),Math.abs(this.lng-t.lng))<=(void 0===e?1e-9:e))},toString:function(t){return"LatLng("+e(this.lat,t)+", "+e(this.lng,t)+")"},distanceTo:function(t){return l.distance(this,f(t))},wrap:function(){return l.wrapLatLng(this)},toBounds:function(t){var e=180*t/40075017,r=e/Math.cos(Math.PI/180*this.lat);return h([this.lat-e,this.lng-r],[this.lat+e,this.lng+r])},clone:function(){return new c(this.lat,this.lng,this.alt)}};const d=t=>{const e=t.valueOf()/864e5-10957.5,r=6.240059966692059+.017201969994578018*e,i=r+.017453292519943295*(1.9148*Math.sin(r)+.02*Math.sin(2*r)+3e-4*Math.sin(3*r))+1.796593062783907+Math.PI,n=Math.atan2(Math.sin(i)*Math.cos(.40909994067971484),Math.cos(i));return{dec:Math.asin(Math.sin(.40909994067971484)*Math.sin(i)),Hi:(4.889714432387314+6.3003876824396166*e-n)%(2*Math.PI)+2*Math.PI}},m=()=>Math.floor(1e7*Math.random()),_=(t,e,r)=>{const i=1/e,n=Math.min(t[0]*i,255),o=Math.min(t[1]*i,255),a=Math.min(t[2]*i,255);let s=0;return n+o+a!==0&&(s=n>0?n/255*.5+.5:a>0?.5*(1-a/255):.5),s*r},x=(t=new Date,e)=>{const r=new Date(t.toLocaleString("en-US",{timeZone:"UTC"})),i=new Date(t.toLocaleString("en-US",e?{timeZone:e}:{}));return r.getTime()-i.getTime()};const g=t=>{const e=()=>!t.getPitch;return{project:(r,n)=>{if(e())return t.project(r,n);{const{lat:t,lng:e}=r;return new i(((t,e)=>(t+180)/360*Math.pow(2,e)*256)(e,n),((t,e)=>(1-Math.log(Math.tan(t*Math.PI/180)+1/Math.cos(t*Math.PI/180))/Math.PI)/2*Math.pow(2,e)*256)(t,n))}},unproject:(r,i)=>{return e()?t.unproject(r,i):new c((n=r.y,o=i,a=Math.PI-2*Math.PI*n/256/Math.pow(2,o),180/Math.PI*Math.atan(.5*(Math.exp(a)-Math.exp(-a)))),function(t,e){return t/256/Math.pow(2,e)*360-180}(r.x,i));var n,o,a},screenUnproject:r=>e()?t.containerPointToLatLng(r):t.unproject(r),getZoom:()=>e()?t.getZoom():t.getZoom()+1,getCenter:()=>t.getCenter(),getBounds:()=>t.getBounds(),eachLayer:r=>{e()&&t.eachLayer(r)},getBearing:()=>e()?0:t.getBearing(),getPitch:()=>e()?0:t.getPitch(),rawMap:()=>t,isLeaflet:e,getPixelDimensions:()=>{const e=t.getContainer();return{width:e.clientWidth,height:e.clientHeight}},createBounds:t=>{const{nw:e,se:r}=t;return new u(e,r)}}};function p(t,e,r,i){return new(r||(r=Promise))((function(n,o){function a(t){try{u(i.next(t))}catch(t){o(t)}}function s(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){var e;t.done?n(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(a,s)}u((i=i.apply(t,e||[])).next())}))}function E(t,e,r){r=r||2;var i,n,o,a,s,u,h,l=e&&e.length,c=l?e[0]*r:t.length,f=T(t,0,c,r,!0),d=[];if(!f||f.next===f.prev)return d;if(l&&(f=function(t,e,r,i){var n,o,a,s=[];for(n=0,o=e.length;n<o;n++)(a=T(t,e[n]*i,n<o-1?e[n+1]*i:t.length,i,!1))===a.next&&(a.steiner=!0),s.push(L(a));for(s.sort(w),n=0;n<s.length;n++)r=F(s[n],r);return r}(t,e,f,r)),t.length>80*r){i=o=t[0],n=a=t[1];for(var m=r;m<c;m+=r)(s=t[m])<i&&(i=s),(u=t[m+1])<n&&(n=u),s>o&&(o=s),u>a&&(a=u);h=0!==(h=Math.max(o-i,a-n))?32767/h:0}return y(f,d,r,i,n,h,0),d}function T(t,e,r,i,n){var o,a;if(n===j(t,e,r,i)>0)for(o=e;o<r;o+=i)a=z(o,t[o],t[o+1],a);else for(o=r-i;o>=e;o-=i)a=z(o,t[o],t[o+1],a);return a&&I(a,a.next)&&(H(a),a=a.next),a}function v(t,e){if(!t)return t;e||(e=t);var r,i=t;do{if(r=!1,i.steiner||!I(i,i.next)&&0!==C(i.prev,i,i.next))i=i.next;else{if(H(i),(i=e=i.prev)===i.next)break;r=!0}}while(r||i!==e);return e}function y(t,e,r,i,n,o,a){if(t){!a&&o&&function(t,e,r,i){var n=t;do{0===n.z&&(n.z=D(n.x,n.y,e,r,i)),n.prevZ=n.prev,n.nextZ=n.next,n=n.next}while(n!==t);n.prevZ.nextZ=null,n.prevZ=null,function(t){var e,r,i,n,o,a,s,u,h=1;do{for(r=t,t=null,o=null,a=0;r;){for(a++,i=r,s=0,e=0;e<h&&(s++,i=i.nextZ);e++);for(u=h;s>0||u>0&&i;)0!==s&&(0===u||!i||r.z<=i.z)?(n=r,r=r.nextZ,s--):(n=i,i=i.nextZ,u--),o?o.nextZ=n:t=n,n.prevZ=o,o=n;r=i}o.nextZ=null,h*=2}while(a>1)}(n)}(t,i,n,o);for(var s,u,h=t;t.prev!==t.next;)if(s=t.prev,u=t.next,o?A(t,i,n,o):R(t))e.push(s.i/r|0),e.push(t.i/r|0),e.push(u.i/r|0),H(t),t=u.next,h=u.next;else if((t=u)===h){a?1===a?y(t=b(v(t),e,r),e,r,i,n,o,2):2===a&&M(t,e,r,i,n,o):y(v(t),e,r,i,n,o,1);break}}}function R(t){var e=t.prev,r=t,i=t.next;if(C(e,r,i)>=0)return!1;for(var n=e.x,o=r.x,a=i.x,s=e.y,u=r.y,h=i.y,l=n<o?n<a?n:a:o<a?o:a,c=s<u?s<h?s:h:u<h?u:h,f=n>o?n>a?n:a:o>a?o:a,d=s>u?s>h?s:h:u>h?u:h,m=i.next;m!==e;){if(m.x>=l&&m.x<=f&&m.y>=c&&m.y<=d&&S(n,s,o,u,a,h,m.x,m.y)&&C(m.prev,m,m.next)>=0)return!1;m=m.next}return!0}function A(t,e,r,i){var n=t.prev,o=t,a=t.next;if(C(n,o,a)>=0)return!1;for(var s=n.x,u=o.x,h=a.x,l=n.y,c=o.y,f=a.y,d=s<u?s<h?s:h:u<h?u:h,m=l<c?l<f?l:f:c<f?c:f,_=s>u?s>h?s:h:u>h?u:h,x=l>c?l>f?l:f:c>f?c:f,g=D(d,m,e,r,i),p=D(_,x,e,r,i),E=t.prevZ,T=t.nextZ;E&&E.z>=g&&T&&T.z<=p;){if(E.x>=d&&E.x<=_&&E.y>=m&&E.y<=x&&E!==n&&E!==a&&S(s,l,u,c,h,f,E.x,E.y)&&C(E.prev,E,E.next)>=0)return!1;if(E=E.prevZ,T.x>=d&&T.x<=_&&T.y>=m&&T.y<=x&&T!==n&&T!==a&&S(s,l,u,c,h,f,T.x,T.y)&&C(T.prev,T,T.next)>=0)return!1;T=T.nextZ}for(;E&&E.z>=g;){if(E.x>=d&&E.x<=_&&E.y>=m&&E.y<=x&&E!==n&&E!==a&&S(s,l,u,c,h,f,E.x,E.y)&&C(E.prev,E,E.next)>=0)return!1;E=E.prevZ}for(;T&&T.z<=p;){if(T.x>=d&&T.x<=_&&T.y>=m&&T.y<=x&&T!==n&&T!==a&&S(s,l,u,c,h,f,T.x,T.y)&&C(T.prev,T,T.next)>=0)return!1;T=T.nextZ}return!0}function b(t,e,r){var i=t;do{var n=i.prev,o=i.next.next;!I(n,o)&&B(n,i,i.next,o)&&X(n,o)&&X(o,n)&&(e.push(n.i/r|0),e.push(i.i/r|0),e.push(o.i/r|0),H(i),H(i.next),i=t=o),i=i.next}while(i!==t);return v(i)}function M(t,e,r,i,n,o){var a=t;do{for(var s=a.next.next;s!==a.prev;){if(a.i!==s.i&&P(a,s)){var u=G(a,s);return a=v(a,a.next),u=v(u,u.next),y(a,e,r,i,n,o,0),void y(u,e,r,i,n,o,0)}s=s.next}a=a.next}while(a!==t)}function w(t,e){return t.x-e.x}function F(t,e){var r=function(t,e){var r,i=e,n=t.x,o=t.y,a=-1/0;do{if(o<=i.y&&o>=i.next.y&&i.next.y!==i.y){var s=i.x+(o-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(s<=n&&s>a&&(a=s,r=i.x<i.next.x?i:i.next,s===n))return r}i=i.next}while(i!==e);if(!r)return null;var u,h=r,l=r.x,c=r.y,f=1/0;i=r;do{n>=i.x&&i.x>=l&&n!==i.x&&S(o<c?n:a,o,l,c,o<c?a:n,o,i.x,i.y)&&(u=Math.abs(o-i.y)/(n-i.x),X(i,t)&&(u<f||u===f&&(i.x>r.x||i.x===r.x&&U(r,i)))&&(r=i,f=u)),i=i.next}while(i!==h);return r}(t,e);if(!r)return e;var i=G(r,t);return v(i,i.next),v(r,r.next)}function U(t,e){return C(t.prev,t,e.prev)<0&&C(e.next,t,t.next)<0}function D(t,e,r,i,n){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-r)*n|0)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-i)*n|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function L(t){var e=t,r=t;do{(e.x<r.x||e.x===r.x&&e.y<r.y)&&(r=e),e=e.next}while(e!==t);return r}function S(t,e,r,i,n,o,a,s){return(n-a)*(e-s)>=(t-a)*(o-s)&&(t-a)*(i-s)>=(r-a)*(e-s)&&(r-a)*(o-s)>=(n-a)*(i-s)}function P(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var r=t;do{if(r.i!==t.i&&r.next.i!==t.i&&r.i!==e.i&&r.next.i!==e.i&&B(r,r.next,t,e))return!0;r=r.next}while(r!==t);return!1}(t,e)&&(X(t,e)&&X(e,t)&&function(t,e){var r=t,i=!1,n=(t.x+e.x)/2,o=(t.y+e.y)/2;do{r.y>o!=r.next.y>o&&r.next.y!==r.y&&n<(r.next.x-r.x)*(o-r.y)/(r.next.y-r.y)+r.x&&(i=!i),r=r.next}while(r!==t);return i}(t,e)&&(C(t.prev,t,e.prev)||C(t,e.prev,e))||I(t,e)&&C(t.prev,t,t.next)>0&&C(e.prev,e,e.next)>0)}function C(t,e,r){return(e.y-t.y)*(r.x-e.x)-(e.x-t.x)*(r.y-e.y)}function I(t,e){return t.x===e.x&&t.y===e.y}function B(t,e,r,i){var n=O(C(t,e,r)),o=O(C(t,e,i)),a=O(C(r,i,t)),s=O(C(r,i,e));return n!==o&&a!==s||(!(0!==n||!N(t,r,e))||(!(0!==o||!N(t,i,e))||(!(0!==a||!N(r,t,i))||!(0!==s||!N(r,e,i)))))}function N(t,e,r){return e.x<=Math.max(t.x,r.x)&&e.x>=Math.min(t.x,r.x)&&e.y<=Math.max(t.y,r.y)&&e.y>=Math.min(t.y,r.y)}function O(t){return t>0?1:t<0?-1:0}function X(t,e){return C(t.prev,t,t.next)<0?C(t,e,t.next)>=0&&C(t,t.prev,e)>=0:C(t,e,t.prev)<0||C(t,t.next,e)<0}function G(t,e){var r=new W(t.i,t.x,t.y),i=new W(e.i,e.x,e.y),n=t.next,o=e.prev;return t.next=e,e.prev=t,r.next=n,n.prev=r,i.next=r,r.prev=i,o.next=i,i.prev=o,i}function z(t,e,r,i){var n=new W(t,e,r);return i?(n.next=i.next,n.prev=i,i.next.prev=n,i.next=n):(n.prev=n,n.next=n),n}function H(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function W(t,e,r){this.i=t,this.x=e,this.y=r,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function j(t,e,r,i){for(var n=0,o=e,a=r-i;o<r;o+=i)n+=(t[a]-t[o])*(t[o+1]+t[a+1]),a=o;return n}function Z(t){t.filter((t=>"MultiPolygon"===t.geometry.type)).forEach((e=>{const{geometry:r,properties:i,type:n}=e;if("MultiPolygon"===r.type)for(let i=0;i<r.coordinates.length;i++)t.push(Object.assign(Object.assign({},e),{geometry:Object.assign(Object.assign({},r),{type:"Polygon",coordinates:r.coordinates[i]})}))}));return t.filter((t=>"Polygon"===t.geometry.type)).map((t=>{const{geometry:e,properties:r}=t,{vertices:i}=E.flatten(e.coordinates),n=new Float32Array(i.map(((t,e)=>{if(e%2==1){const e=t*Math.PI/180;return Math.tan(e)+1/Math.cos(e)}return t}))),o=E(i),a=o.length>256?new Uint16Array(o):new Uint8Array(o),s=function(t){const{height:e=0,levels:r=0,render_height:i=0}=t;if(r)return 3.04*r;return Math.max(e,i)}(r),u=r.highlight||!1;let h=0,l=0,c=0;for(let t=0;t<i.length;t+=2)h+=i[t],l+=i[t+1],c++;return{aPosition:n,cuts:a,buildingHeight:s,centroid:[h/c,l/c],highlight:u}}))}E.deviation=function(t,e,r,i){var n=e&&e.length,o=n?e[0]*r:t.length,a=Math.abs(j(t,0,o,r));if(n)for(var s=0,u=e.length;s<u;s++){var h=e[s]*r,l=s<u-1?e[s+1]*r:t.length;a-=Math.abs(j(t,h,l,r))}var c=0;for(s=0;s<i.length;s+=3){var f=i[s]*r,d=i[s+1]*r,m=i[s+2]*r;c+=Math.abs((t[f]-t[m])*(t[d+1]-t[f+1])-(t[f]-t[d])*(t[m+1]-t[f+1]))}return 0===a&&0===c?0:Math.abs((c-a)/a)},E.flatten=function(t){for(var e=t[0][0].length,r={vertices:[],holes:[],dimensions:e},i=0,n=0;n<t.length;n++){for(var o=0;o<t[n].length;o++)for(var a=0;a<e;a++)r.vertices.push(t[n][o][a]);n>0&&(i+=t[n-1].length,r.holes.push(i))}return r};const Y=(t,e)=>{const{lat:r,lng:n}=t;return new i(((t,e)=>(t+180)/360*Math.pow(2,e)*256)(n,e),((t,e)=>(1-Math.log(Math.tan(t*Math.PI/180)+1/Math.cos(t*Math.PI/180))/Math.PI)/2*Math.pow(2,e)*256)(r,e))},K=(t,e)=>{return new c((r=t.y,i=e,n=Math.PI-2*Math.PI*r/256/Math.pow(2,i),180/Math.PI*Math.atan(.5*(Math.exp(n)-Math.exp(-n)))),function(t,e){return t/256/Math.pow(2,e)*360-180}(t.x,e));var r,i,n};let k,q={heightMapTex:null,width:0,height:0,visibleDEMPixelBounds:new a(new i(0,0),new i(0,0)),DEMPixelBounds:new a(new i(0,0),new i(0,0)),maxHeight:8848,raster:[],demZoom:0,dirty:!1,outputWidth:0,outputHeight:0};const V=t=>p(void 0,void 0,void 0,(function*(){const{demZoom:e,getFeatures:r,terrainSource:n,dsmSource:o,tileLoaded:s,gl:h,bounds:l,buildingRasterizer:c,tileMerger:f,forceUpdate:d=!1}=t,{getSourceUrl:m,getElevation:_,maxZoom:x,tileSize:g,_overzoom:E}=n,T=(v={getFeatures:r},p(void 0,void 0,void 0,(function*(){const{getFeatures:t}=v;try{return Z(yield t())}catch(t){console.log("Error merging buildings",t)}return[]})));var v;try{const t=l,r=t.getNorthWest(),n=t.getSouthEast(),p=new a(Y(r,e),Y(n,e));let E=new i(p.min.x,p.min.y),v=p.max.x-p.min.x;const y=p.max.y-p.min.y,R=p.max.subtract(p.min);R.y>R.x&&(E.x-=256,v+=512);const A=(t=>{const{upperLeft:e,width:r,height:i}=t,n=e.divideBy(256).floor().multiplyBy(256),o=256*(Math.ceil(r/256)+1),s=256*(Math.ceil(i/256)+1),u=n.add([o,s]);return new a(n,u)})({upperLeft:E,width:v,height:y}),{x:b,y:M}=A.max.subtract(A.min),w=(t=>{t.sort(((t,e)=>t.y!==e.y?t.y-e.y:t.x-e.x));const e=t.reduce(((t,e)=>e.x<t.x?e:t)).x,r=t.reduce(((t,e)=>e.y<t.y?e:t)).y;return t.map((t=>{const i=Math.pow(2,t.z);return{x:(t.x%i+i)%i,y:(t.y%i+i)%i,z:t.z,xOffset:256*(t.x-e),yOffset:256*(t.y-r)}}))})((t=>{const{upperLeft:e,width:r,height:i,zoom:n}=t,o=e.divideBy(256).floor(),a=o.x+r/256,s=Math.min(o.y+i/256,Math.pow(2,n)-1),u=[];for(var h=o.x;h<a;h++)for(var l=o.y;l<s;l++)u.push({x:h,y:l,z:n});return u})({upperLeft:A.min,width:b,height:M,zoom:e})),F=p.max.x-p.min.x,U=p.max.y-p.min.y,D=Math.round(F),L=Math.round(U),S=JSON.stringify(w);if(!d&&S===k&&e<x)return q=Object.assign(Object.assign({},q),{outputWidth:D,outputHeight:L,visibleDEMPixelBounds:p,demZoom:e,dirty:!0}),q;const P=yield f.merge(w,{maxZoom:x,width:b,height:M,crossOrigin:"Anonymous",getSourceUrl:m,getElevation:_,tileSize:g,tileLoaded:s});if(null===P)return q=Object.assign(Object.assign({},q),{visibleDEMPixelBounds:p,demZoom:e,dirty:!1}),q;const C=new a(Y(new u(o.bounds).getNorthWest(),e),Y(new u(o.bounds).getSouthEast(),e)),I=C.min.subtract(A.min),B=C.max.subtract(A.min),N=[I.x/b,I.y/M,B.x/b,B.y/M].map((t=>2*t-1)),O=yield T,{maxHeight:X,heightMapTex:G}=c.raster({upperLeftTile:w[0],width:b,height:M,mapZoom:e,features:O,imageData:P,gl:h,dsmSource:o,dsmCoords:N}),z=Math.max(Math.max(o.maxHeight,X),P.maxHeight);k=S,q={heightMapTex:G,maxHeight:z,width:b,height:M,DEMPixelBounds:A,visibleDEMPixelBounds:p,raster:w,demZoom:e,dirty:!0,outputWidth:D,outputHeight:L}}catch(t){console.error("Could not decode height map",t)}return q})),$=(t,e)=>{const{r:r,g:i,b:n}=t;return[r/255,i/255,n/255,e]},J=(t,e)=>{const{date:r}=e,{dec:i,Hi:n}=d(r);t.updateDate({dec:i,Hi:n})},Q=(t,e)=>p(void 0,void 0,void 0,(function*(){return yield t.updateDateRange(Object.assign({},e))})),tt=(t,e)=>{const{color:r,opacity:i}=e,n=$(r,i);t.updateColor({colorVec:n})};new u([0,0],[0,0]);const et=t=>{const{kernel:e,map:r,heightMap:i,now:n,color:o,opacity:a,belowCanopy:s}=t;try{const{heightMapTex:t,outputHeight:h,outputWidth:l,maxHeight:c,width:f,height:m,DEMPixelBounds:_,visibleDEMPixelBounds:x,demZoom:g}=i;if(0===f||0===m)return;const{min:p,max:E}=x;if(!p||!E)return;const{x:T,y:v}=E.subtract(p),y=_.min,R=r.getPixelDimensions(),A=r.screenUnproject([0,0]),b=r.screenUnproject([R.width,0]),M=r.screenUnproject([R.width,R.height]),w=r.screenUnproject([0,R.height]),F=[w,M,A,b].map((t=>r.project(t,g))),U=F.map((t=>[(t.x-y.x)/f,(t.y-y.y)/m])).flat(),D=F.map((t=>[(t.x-p.x)/T,(t.y-p.y)/v])).map((t=>[2*t[0]-1,(2*t[1]-1)*(r.isLeaflet()?-1:1)])).flat(),L=y.y/256/Math.pow(2,g),S=m/256/Math.pow(2,g),P=new u(K(_.getTopLeft(),g),K(_.getBottomRight(),g)),C=P.getWest(),I=Math.abs(P.getWest()-P.getEast());((t,e)=>{const{color:r,opacity:i,date:n}=e,o=$(r,i),{dec:a,Hi:s}=d(n);t.updateLocation(Object.assign({dec:a,Hi:s,colorVec:o,step:1},e))})(e,{heightMapTex:t,maxHeight:c,width:f,height:m,heightMapZoom:g,cornerTextureCoords:U,cornerClipCoords:D,topYCoord:L,ySize:S,west:C,dLng:I,date:n,color:o,opacity:a,outputHeight:h,outputWidth:l,belowCanopy:s})}catch(t){console.error("EXCEPTION",t)}};const rt=t=>{const{gl:e}=t,{texture:r,imageData:i=null,format:n=e.RGBA,width:o,height:a,filter:s=e.NEAREST,wrap:u=e.CLAMP_TO_EDGE,type:h=e.UNSIGNED_BYTE,internalFormat:l=n}=t;e.bindTexture(e.TEXTURE_2D,r),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,u),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,u),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,s),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,s),e.texImage2D(e.TEXTURE_2D,0,l,o,a,0,n,h,i)};function it(t){const{gl:e,vSrc:r,fSrc:i}=t,n=e.createShader(e.VERTEX_SHADER);e.shaderSource(n,r),e.compileShader(n);const o=e.createShader(e.FRAGMENT_SHADER);e.shaderSource(o,i),e.compileShader(o);const a=e.createProgram();return e.attachShader(a,n),e.attachShader(a,o),e.linkProgram(a),a}class nt{constructor(t){this.gl=t,this.program=it({gl:t,vSrc:"\nuniform vec3 xyz;\nuniform vec2 dimensions;\nuniform bool use_dsm;\nattribute vec2 dsm_position;\nattribute vec2 a_position;\nfloat PI = 3.141592653589793;\nvarying vec2 vCoord;\nvarying float v_use_dsm;\n\n\tvoid main() {\n\t\tif (use_dsm == true) {\n\t\t\tgl_Position = vec4(a_position, 0, 1);\n\t\t\tvCoord = dsm_position;\n      v_use_dsm = 1.0;\n\t\t\treturn;\n\t\t}\n\t\tif (abs(a_position) == vec2(1,1)) {\n\t\t\tgl_Position = vec4(a_position, 0, 1);\n\t\t\tvCoord = a_position * 0.5 + 0.5;\n\t\t\treturn;\n\t\t}\n\t\tfloat x = ((a_position.x + 180.0) / 360.0 * pow(2.0, xyz.z)) * 256.0 - xyz.x;\n\t\tfloat y = (1.0 - (log(a_position.y) / PI)) / 2.0 * pow(2.0, xyz.z) * 256.0 - xyz.y;\n\t\tvec2 transformed = vec2(x, y);\n\t\tvec2 normalized = transformed / dimensions;\n\t\tvec2 final = normalized * 2.0 - 1.0;\n\t\tgl_Position = vec4(final, 0, 1);\n\t}\n",fSrc:"\n#ifdef GL_FRAGMENT_PRECISION_HIGH\n  precision highp float;\n#else\n  precision mediump float;\n#endif\n\nuniform vec4 color;\nuniform sampler2D height_map;\nvarying vec2 vCoord;\nvarying float v_use_dsm;\n\nvoid main() {\n\tif (color == vec4(0,0,0,0)) {\n\t \tvec4 textureColor = texture2D(height_map, vec2(vCoord.x, vCoord.y));\n    if (v_use_dsm == 1.0) {\n\t \t  gl_FragColor = vec4(0.0, 0.0, textureColor.b, textureColor.a);\n    if (gl_FragColor.zw == vec2(0.0)) {\n      discard;\n    }\n    } else {\n      gl_FragColor = vec4(textureColor.b, textureColor.a, textureColor.b, textureColor.a);\n    }\n    // DSM noData values should not be included in heightMap because they produce ugly borders\n\t\treturn;\n\t} \n\tgl_FragColor = color;\n}\n"}),this.positionAttributeLocation=t.getAttribLocation(this.program,"a_position"),this.dsmAttributeLocation=t.getAttribLocation(this.program,"dsm_position"),this.useDSMUniformLocation=t.getUniformLocation(this.program,"use_dsm"),this.xyzUniformLocation=t.getUniformLocation(this.program,"xyz"),this.dimensionsUniformLocation=t.getUniformLocation(this.program,"dimensions"),this.heightMapUniformLocation=t.getUniformLocation(this.program,"height_map"),this.colorUniformLocation=t.getUniformLocation(this.program,"color"),this.positionBuffer=t.createBuffer(),this.dsmBuffer=t.createBuffer(),this.indexBuffer=t.createBuffer(),this.targetTexture=t.createTexture()}raster(t){const{features:e,upperLeftTile:r,mapZoom:n,width:o,height:a,imageData:s,dsmCoords:u,dsmSource:h,gl:l}=t,{x:c,y:f,z:d}=r;let m=0;l.useProgram(this.program),l.activeTexture(l.TEXTURE1);const _=l.createTexture();l.bindTexture(l.TEXTURE_2D,_),l.pixelStorei(l.UNPACK_ALIGNMENT,2),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MIN_FILTER,l.NEAREST),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MAG_FILTER,l.NEAREST),l.texImage2D(l.TEXTURE_2D,0,l.LUMINANCE_ALPHA,o,a,0,l.LUMINANCE_ALPHA,l.UNSIGNED_BYTE,s),l.pixelStorei(l.UNPACK_ALIGNMENT,4);const x=o,g=a;l.activeTexture(l.TEXTURE0),l.bindTexture(l.TEXTURE_2D,this.targetTexture),l.texImage2D(l.TEXTURE_2D,0,l.RGBA,x,g,0,l.RGBA,l.UNSIGNED_BYTE,null),n>15&&e.length>5?(l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MIN_FILTER,l.NEAREST),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MAG_FILTER,l.NEAREST)):(l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MIN_FILTER,l.LINEAR),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MAG_FILTER,l.LINEAR)),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),l.viewport(0,0,x,g);const p=l.createFramebuffer();l.bindFramebuffer(l.FRAMEBUFFER,p);const E=l.COLOR_ATTACHMENT0;l.framebufferTexture2D(l.FRAMEBUFFER,E,l.TEXTURE_2D,this.targetTexture,0),l.disable(l.BLEND),l.bindBuffer(l.ARRAY_BUFFER,this.positionBuffer),l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,this.indexBuffer),l.clearColor(0,0,0,0),l.clear(l.COLOR_BUFFER_BIT);const T=256*c,v=256*f,y=new i(T,v);l.uniform3f(this.xyzUniformLocation,T,v,d),l.uniform2f(this.dimensionsUniformLocation,o,a),l.uniform1i(this.heightMapUniformLocation,1),l.uniform1i(this.useDSMUniformLocation,0);const R=new Float32Array([-1,-1,1,-1,-1,1,1,1]);if(l.enableVertexAttribArray(this.positionAttributeLocation),l.bufferData(l.ARRAY_BUFFER,R,l.STATIC_DRAW),l.vertexAttribPointer(this.positionAttributeLocation,2,l.FLOAT,!1,0,0),l.uniform4f(this.colorUniformLocation,0,0,0,0),l.drawArrays(l.TRIANGLE_STRIP,0,4),e.forEach((t=>{const{buildingHeight:e,aPosition:r,cuts:i,centroid:n,highlight:u}=t,h=Y({lng:n[0],lat:n[1]},d).subtract(y).floor();if(h.x<0||h.y<0||h.x>o||h.y>a)return;const c=256*s[h.y*o*2+2*h.x]+s[h.y*o*2+2*h.x+1]+5*e,f=Math.floor(c/256)/255,_=Math.floor(c%256)/255;m=Math.max(m,c/5),l.uniform4f(this.colorUniformLocation,f,_,f,_),l.bufferData(l.ARRAY_BUFFER,r,l.DYNAMIC_DRAW),l.vertexAttribPointer(this.positionAttributeLocation,2,l.FLOAT,!1,0,0),l.bufferData(l.ARRAY_BUFFER,r,l.DYNAMIC_DRAW),l.vertexAttribPointer(this.dsmAttributeLocation,2,l.FLOAT,!1,0,0),l.bufferData(l.ELEMENT_ARRAY_BUFFER,i,l.DYNAMIC_DRAW),l.drawElements(l.TRIANGLES,i.length,i.length>256?l.UNSIGNED_SHORT:l.UNSIGNED_BYTE,0)})),l.deleteTexture(_),0!==h.data.length){l.activeTexture(l.TEXTURE1);const t=l.createTexture();l.bindTexture(l.TEXTURE_2D,t),l.pixelStorei(l.UNPACK_ALIGNMENT,2),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MIN_FILTER,l.NEAREST),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MAG_FILTER,l.NEAREST),l.texImage2D(l.TEXTURE_2D,0,l.LUMINANCE_ALPHA,h.width,h.height,0,l.LUMINANCE_ALPHA,l.UNSIGNED_BYTE,h.data),l.pixelStorei(l.UNPACK_ALIGNMENT,4);const e=[u[0],u[3],u[2],u[3],u[0],u[1],u[2],u[1]],r=new Float32Array(e);l.enableVertexAttribArray(this.positionAttributeLocation),l.bufferData(l.ARRAY_BUFFER,r,l.STATIC_DRAW),l.vertexAttribPointer(this.positionAttributeLocation,2,l.FLOAT,!1,0,0),l.enableVertexAttribArray(this.dsmAttributeLocation),l.bindBuffer(l.ARRAY_BUFFER,this.dsmBuffer),l.bufferData(l.ARRAY_BUFFER,new Float32Array([0,1,1,1,0,0,1,0]),l.STATIC_DRAW),l.vertexAttribPointer(this.dsmAttributeLocation,2,l.FLOAT,!1,0,0),l.uniform4f(this.colorUniformLocation,0,0,0,0),l.uniform1i(this.useDSMUniformLocation,1),l.colorMask(!1,!1,!0,!0),l.drawArrays(l.TRIANGLE_STRIP,0,4),l.deleteTexture(t)}return l.colorMask(!0,!0,!0,!0),l.deleteFramebuffer(p),{maxHeight:m,heightMapTex:this.targetTexture}}}const ot=t=>{const{tile:e,maxZoom:r,tileSize:i}=t;let{x:n,y:o,z:a}=e;if(a>r){const t=Math.pow(2,e.z-r);n=Math.floor(n/t),o=Math.floor(o/t),a=r}return{x:256===i?n:Math.floor(n/2),y:256===i?o:Math.floor(o/2),z:256===i?a:a-1}};class at{constructor(t){this.gl=t,this.program=it({vSrc:"\n    attribute vec4 a_position;\n    varying vec2 v_pos;\n    void main() {\n      v_pos = ((a_position + 1.0) * 0.5).xy;\n        gl_Position = a_position;\n    }\n",fSrc:"\n    precision mediump float;\n    varying vec2 v_pos;\n    uniform sampler2D u_texture;\n    void main() {\n        gl_FragColor = texture2D(u_texture, v_pos);\n    }\n",gl:t}),t.useProgram(this.program),this.positionAttributeLocation=t.getAttribLocation(this.program,"a_position"),this.positionBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.positionBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,1,1]),t.STATIC_DRAW),t.enableVertexAttribArray(this.positionAttributeLocation),t.vertexAttribPointer(this.positionAttributeLocation,2,t.FLOAT,!1,0,0),this.tileTexture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this.tileTexture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),this.outputTexture=t.createTexture(),this.framebuffer=t.createFramebuffer(),this.inProgress=[],this.finished=0}merge(t,e){return p(this,void 0,void 0,(function*(){const r=this.gl,{width:i,height:n,crossOrigin:o,getSourceUrl:a,getElevation:s,tileSize:u,tileLoaded:h,maxZoom:l}=e;if(r){const e=new Uint8ClampedArray(2*i*n);e.maxHeight=0,this.inProgress.forEach((t=>t.src="")),this.inProgress=[],this.finished=0;const c=new Set;t.forEach((t=>{c.add(a(ot({tile:t,maxZoom:l,tileSize:u})))}));const f=Array.from(c).map((n=>p(this,void 0,void 0,(function*(){return new Promise(((h,c)=>{const f=new Image;this.inProgress.push(f),f.onload=()=>{t.filter((t=>n===a(ot({tile:t,maxZoom:l,tileSize:u})))).forEach((t=>{let n=0,o=0;const a=514===u?1:0;let h=0,c=256,d=256;if(256!==u&&(n=t.x%2*256,o=t.y%2*256,c=256,d=256),t.z>l){const e=Math.pow(2,t.z-l);256!==u&&(n=Math.floor(t.x/e)%2*256,o=Math.floor(t.y/e)%2*256),n+=t.x%e/e*256,o+=t.y%e/e*256,c=256/e,d=256/e,h=514===u?1:0}r.useProgram(this.program),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this.tileTexture),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,f),r.activeTexture(r.TEXTURE1),rt({gl:r,texture:this.outputTexture,imageData:null,format:r.RGBA,width:u,height:u,wrap:r.CLAMP_TO_EDGE,filter:r.NEAREST}),r.bindFramebuffer(r.FRAMEBUFFER,this.framebuffer),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,this.outputTexture,0);const m=r.checkFramebufferStatus(r.FRAMEBUFFER);m!==r.FRAMEBUFFER_COMPLETE&&console.error("Framebuffer is incomplete: "+m),r.bindBuffer(r.ARRAY_BUFFER,this.positionBuffer),r.enableVertexAttribArray(this.positionAttributeLocation),r.vertexAttribPointer(this.positionAttributeLocation,2,r.FLOAT,!1,0,0),r.viewport(0,0,u,u),r.clear(r.COLOR_BUFFER_BIT),r.drawArrays(r.TRIANGLE_STRIP,0,4);const _=new Uint8Array(4*(c+h)*(d+h));r.readPixels(a+n,a+o,c+h,d+h,r.RGBA,r.UNSIGNED_BYTE,_),r.bindFramebuffer(r.FRAMEBUFFER,null);const x=new Uint8ClampedArray(131072);let g=new Array((c+h)*(d+h)),p=256/c;for(let t=0;t<_.length;t+=4){const r=s({r:_[t],g:_[t+1],b:_[t+2],a:_[t+3]});e.maxHeight=Math.max(r,e.maxHeight);const i=5*(r||0);g[t/4]=i}if(p>1&&514===u)for(g=function(t,e,r,i){const n=Math.floor(e*i),o=Math.floor(r*i),a=[];for(let s=0;s<o;s++)for(let o=0;o<n;o++){const n=o/i,u=s/i,h=Math.floor(n),l=Math.floor(u),c=Math.min(h+1,e-1),f=Math.min(l+1,r-1),d=n-h,m=u-l,_=l*e+c,x=f*e+h,g=f*e+c,p=t[l*e+h]*(1-d)*(1-m)+t[_]*d*(1-m)+t[x]*(1-d)*m+t[g]*d*m;a.push(p)}return function(t,e,r,i,n){if(i>=e||n>=r)return[];const o=e-i,a=r-n,s=[];for(let r=0;r<a;r++)for(let i=0;i<o;i++){const n=r*e+i;s.push(t[n])}return s}(a,Math.sqrt(a.length),Math.sqrt(a.length),i,i)}(g,c+1,d+1,p);p>1;)p/=2,d*=2,c*=2;for(let t=0;t<x.length;t+=2){const e=g[Math.floor(t/2/256/p)*c+Math.floor(t/2%256/p)],r=Math.floor(e/256),i=Math.floor(e%256);x[t]=r,x[t+1]=i}for(let r=0;r<256;r++)e.set(x.slice(256*r*2,256*(r+1)*2),2*(t.yOffset*i+r*i+t.xOffset))})),h(null)},f.onerror=t=>{if(f.src!==f.originalSource)return c("new tiles requested");h(null)},f.crossOrigin=o||null,f.src=n,f.originalSource=f.src})).then((()=>{this.finished++,h(this.finished,this.inProgress.length)}))}))));try{yield Promise.all(f)}catch(t){return console.log(`${f.length} requests aborted`,t),null}return this.inProgress=[],e}throw new Error("Could not get canvas context for merging tile images")}))}}class st extends class extends class{constructor(){this.events={}}on(t,e){return"object"!=typeof this.events[t]&&(this.events[t]=[]),this.events[t].push(e),()=>this.removeListener(t,e)}removeListener(t,e){if("object"!=typeof this.events[t])return;const r=this.events[t].indexOf(e);r>-1&&this.events[t].splice(r,1)}removeAllListeners(){Object.keys(this.events).forEach((t=>this.events[t].splice(0,this.events[t].length)))}emit(t,...e){"object"==typeof this.events[t]&&[...this.events[t]].forEach((t=>t.apply(this,e)))}once(t,e){const r=this.on(t,((...t)=>{r(),e.apply(this,t)}));return r}}{constructor(...t){super(),this.options={date:new Date,color:"000",opacity:.3,sunExposure:{enabled:!1,startDate:new Date,endDate:new Date,iterations:32},apiKey:"",terrainSource:{maxZoom:15,tileSize:256,_overzoom:15,getSourceUrl:t=>"https://s3.amazonaws.com/elevation-tiles-prod/terrarium/7/17/45.png",getElevation:t=>{const{r:e,g:r,b:i}=t;return 256*e+r+i/256-32768}},dsmSource:{bounds:[{lat:0,lng:0},{lat:0,lng:0}],data:new Uint8ClampedArray,width:0,height:0,maxHeight:0},belowCanopy:!1,getFeatures:()=>Promise.resolve([]),getSize:()=>({width:Number.NaN,height:Number.NaN}),debug:t=>{}};const e=t[0];if(this.options=Object.assign(this.options,e),!this.options.apiKey)throw new Error("Could not load ShadeMap: apiKey missing");fetch("https://shademap.app/sdk/load",{method:"POST",body:JSON.stringify({api_key:this.options.apiKey}),headers:{"Content-Type":"application/json"}}).then((t=>p(this,void 0,void 0,(function*(){if(200!==t.status)throw new Error(yield t.text())})))).catch((t=>p(this,void 0,void 0,(function*(){throw new Error(`Could not load ShadeMap API. Key: ${this.options.apiKey} Error: ${t}`)})))),this._canvas=document.createElement("canvas"),this._color=this._parseColor(this.options.color),this._reset=this._reset.bind(this),this._draw=this._draw.bind(this)}onRemove(){return this._map&&this._map.off("moveend",this._reset),this}setDate(t){return this.options.date.getTime()!==t.getTime()?(this.options.date=t,this._compiledKernel&&(J(this._compiledKernel,{date:this.options.date}),this._flush())):this.emit("idle"),this}_setDateForTimezone(t,e){let r=0;e&&(r=x(this.options.date)-x(this.options.date,e)),this.setDate(new Date(t.getTime()-r))}setColor(t){return this.options.color!==t&&(this.options.color=t,this._color=this._parseColor(this.options.color),this._compiledKernel&&(tt(this._compiledKernel,{color:this._color,opacity:this.options.opacity}),this._flush())),this}setOpacity(t){return this.options.opacity!==t&&(this.options.opacity=t,this._compiledKernel&&(tt(this._compiledKernel,{color:this._color,opacity:this.options.opacity}),this._flush())),this}setBelowCanopy(t){return this.options.belowCanopy=t,this._heightMap?this._draw(this._heightMap):this._reset(),this}setTerrainSource(t){return this.options.terrainSource=t,delete this._heightMap,this._reset(),this}setDSMSource(t){return this.options.dsmSource=t,delete this._heightMap,this._reset(),this}setSunExposure(t=!1,e){return p(this,void 0,void 0,(function*(){if(this.options.sunExposure=Object.assign(Object.assign({},this.options.sunExposure),{enabled:t}),e){const{startDate:r=new Date,endDate:i=new Date,iterations:n=32}=e;this.options.sunExposure={enabled:t,startDate:r,endDate:i,iterations:n}}if(this._map&&this._compiledKernel&&this._heightMap){if(!1===t)J(this._compiledKernel,{date:this.options.date});else{const{startDate:t,endDate:e,iterations:r}=this.options.sunExposure;if(!(t instanceof Date&&e instanceof Date))throw new Error("Start date or end date or both are missing");if(e.getTime()<t.getTime())throw new Error("End date must come after the start date to calculate sun exposure");if(!0===(yield Q(this._compiledKernel,{startDate:t,endDate:e,iterations:r,emit:this.emit.bind(this)})))return this}this._flush()}return this}))}_lngLatToTextureCoords(t){if(this._heightMap){const{DEMPixelBounds:e,demZoom:r,width:i,height:n}=this._heightMap,o=e.min;return t.map((t=>{const e=Y(t,r);return[(e.x-o.x)/i,(e.y-o.y)/n]}))}return[]}_getBounds(t,e){const{width:r,height:n}=this.options.getSize();if(Number.isNaN(r)||Number.isNaN(n))return t.getBounds();const o=t.getCenter(),a=Y(o,e),s=K(new i(a.x-r/2,a.y-n/2),e),u=K(new i(a.x+r/2,a.y+n/2),e);return t.createBounds({nw:s,se:u})}_getDEMZoom(t){const e=Math.min(this.options.terrainSource._overzoom||this.options.terrainSource.maxZoom,t.getZoom());return Math.round(e)}_reset(){return p(this,void 0,void 0,(function*(){if(this.options.debug("_reset()"),this._map){const t=g(this._map);let e=this._getDEMZoom(t);try{this._bounds=this._getBounds(t,e)}catch(t){return console.error("Invalid bounds returned: ",t),this}try{if(!t.isLeaflet()&&this._map.getPitch()>45){yield new Promise((t=>{this._map.loaded()?t(!0):this._map.once("idle",(function(){t(!0)}))}));const r=this._map.style._sourceCaches["other:composite"].getVisibleCoordinates().reverse(),n=r.reduce(((t,e)=>Math.max(t,e.canonical.z)),Number.MIN_SAFE_INTEGER),o=r.filter((t=>t.canonical.z===n)).map((t=>t.canonical)),[a,s,u,h]=o.reduce(((t,e)=>[Math.min(t[0],e.x),Math.min(t[1],e.y),Math.max(t[2],e.x),Math.max(t[3],e.y)]),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,Number.MIN_SAFE_INTEGER,Number.MIN_SAFE_INTEGER]),l=K(new i(512*a,512*s),n+1),c=K(new i(512*(u+1),512*(h+1)),n+1);e=n+1,this._bounds=t.createBounds({nw:l,se:c})}}catch(t){console.log("Mapbox tile optimization failed",t)}const r=yield V({gl:this._gl,demZoom:e,bounds:this._bounds,terrainSource:this.options.terrainSource,dsmSource:this.options.dsmSource,getFeatures:this.options.getFeatures,buildingRasterizer:this._buildingRasterizer,tileMerger:this._tileMerger,tileLoaded:(t,e)=>this.emit("tileloaded",t,e),forceUpdate:!this._heightMap});this._heightMap=r,r.dirty&&(yield this._draw(r))}return this}))}_draw(t){return p(this,void 0,void 0,(function*(){if(this.options.debug("_draw()"),this._canvas&&this._compiledKernel&&this._map){if(et({kernel:this._compiledKernel,map:g(this._map),heightMap:t,color:this._color,belowCanopy:this.options.belowCanopy,opacity:this.options.opacity,now:this.options.date,maxZoom:this.options.terrainSource.maxZoom}),this.options.sunExposure.enabled){const{startDate:t,endDate:e,iterations:r}=this.options.sunExposure;if(!0===(yield Q(this._compiledKernel,{startDate:t,endDate:e,iterations:r,emit:this.emit.bind(this)})))return this}this._bounds&&this._repositionCanvas(this._bounds)}return this}))}readPixel(t,e){const r=new Uint8Array(4);return this._gl&&this._gl.readPixels(t,e,1,1,this._gl.RGBA,this._gl.UNSIGNED_BYTE,r),r}readPixels(t,e,r,i){const n=new Uint8Array(r*i*4);return this._gl&&this._gl.readPixels(t,e,r,i,this._gl.RGBA,this._gl.UNSIGNED_BYTE,n),n}toGeoTiff(){const t=(t,e)=>{const r=this.readPixels(0,0,t,e),i=t*e*1,n=1*t,o=(e-1)*n,a=new Uint8Array(i),s=new Uint8Array(i);let u=0;const{startDate:h,endDate:l}=this.options.sunExposure;this.options.sunExposure.enabled&&h&&l&&(u=l.getTime()-h.getTime());for(let t=0;t<r.length;t+=4){let e;if(this.options.sunExposure.enabled){const i=r.subarray(t,t+3),n=_(i,.5,u)/1e3/60,o=Math.min(Math.floor(n/6),255);e=new Uint8Array([o])}else{e=r[t]+r[t+1]+r[t+2]===0?new Uint8Array([255]):new Uint8Array([0])}a.set(e,t/4*1)}if(this._map&&!g(this._map).isLeaflet())return a;for(let t=0;t<i;t+=n)s.set(a.subarray(t,t+n),o-t);return s};if(this._map&&this._heightMap){const e=this._heightMap.outputWidth,r=this._heightMap.outputHeight,i=t(e,r),n=g(this._map),{lat:o,lng:a}=n.getBounds().getNorthWest(),s=n.getBounds().getSouthEast(),u=[0,0,0,a,o,0],h=[(s.lng-a)/e,(o-s.lat)/r,0];return this.options.sunExposure.enabled,{data:i,metadata:{width:e,height:r,ModelTiepoint:u,ModelPixelScale:h,GeographicTypeGeoKey:4326,GeogCitationGeoKey:"WGS 84"}}}return null}_generateShadeProfile(t){if(this._compiledKernel){const e=this._lngLatToTextureCoords(t.locations);return((t,e)=>{const r=$({r:e.sunColor[0],g:e.sunColor[1],b:e.sunColor[2]},1),i=$({r:e.shadeColor[0],g:e.shadeColor[1],b:e.shadeColor[2]},1);return t.generateShadeProfile(Object.assign(Object.assign({},e),{sunColor:r,shadeColor:i}))})(this._compiledKernel,Object.assign(Object.assign({},t),{texCoords:e}))}return new Uint8Array}_generateLocationShadeProfile(t){if(this._compiledKernel){const e=x(t.startDate)-x(t.startDate,t.tzId),r=t.startDate.getTime()-e,i=(t.endDate.getTime()-e-r)/86400/1e3,n=1440,o=[],a=828e5,s=x(new Date(r),t.tzId);for(let e=0;e<i;e++){const i=x(new Date(r+86400*e*1e3+a),t.tzId)-s;o[e]=i}const u=[];for(let t=0;t<n;t++){const e=[];for(let n=0;n<i;n++){const i=r+86400*n*1e3+60*t*1e3;e.push(new Date(i+o[n]))}u.push(e)}const h=this._lngLatToTextureCoords([t.location])[0],l=((t,e)=>{const r=$({r:e.sunColor[0],g:e.sunColor[1],b:e.sunColor[2]},1),i=$({r:e.shadeColor[0],g:e.shadeColor[1],b:e.shadeColor[2]},1);return t.generateLocationShadeProfile(Object.assign(Object.assign({},e),{sunColor:r,shadeColor:i}))})(this._compiledKernel,Object.assign(Object.assign({},t),{dates:u,texCoord:h}));return l.toArray=function(){const e=new Array;for(let r=0;r<i;r++){const o=[];for(let e=n-1;e>=0;e--){const n=e*i*4+4*r,a=this.slice(n,n+4);o.push(a.join("")===t.sunColor.join("")?1:0)}e.push(o)}return e},{data:l,width:i,height:n}}return{data:new Uint8Array,width:0,height:0}}getHoursOfSun(t,e){if(this.options.sunExposure.enabled){const r=this.readPixel(t,e),{startDate:i,endDate:n}=this.options.sunExposure,o=n.getTime()-i.getTime(),a=_(r,.5,o);return Math.abs(a/1e3/3600)}return 0}_repositionCanvas(t){}_flush(){}flushSync(){this._gl&&this._gl.finish()}_parseColor(t){t=t.replace("#","");const e={r:0,g:0,b:0};return/^([0-9A-F]{3}){1,2}$/i.test(t)&&(3===t.length?(e.r=parseInt(t[0]+t[0],16),e.g=parseInt(t[1]+t[1],16),e.b=parseInt(t[2]+t[2],16)):6===t.length&&(e.r=parseInt(t[0]+t[1],16),e.g=parseInt(t[2]+t[3],16),e.b=parseInt(t[4]+t[5],16))),e}}{constructor(t){super(t),this.id="shademap-layer",this.type="custom",this.canvasSourceId="canvas-source",this.attributionSourceId="attribution-source",this.canvasLayerId="canvas-layer",this.attributionLayerId="attribution-layer",this._refreshing=0,this._raf=0,this.id=this.id+m(),this.canvasSourceId=this.canvasSourceId+m(),this.attributionSourceId=this.attributionSourceId+m(),this.canvasLayerId=this.canvasLayerId+m(),this.attributionLayerId=this.attributionLayerId+m(),this.options.terrainSource.tileSize>256&&(this.options.terrainSource.maxZoom=this.options.terrainSource.maxZoom+1),this._moveEndHandler=()=>{this._map&&this._reset()}}render(t,e){}addTo(t){return t.addLayer(this),this}onAdd(t){this._map=t,this._gl=this._map.painter.context.gl,this._framebuffer=this._gl.createFramebuffer();this._compiledKernel=function(t){const{context:e,setRenderBuffer:r}=t,i=e,n=it({gl:i,vSrc:"precision lowp float;precision lowp int;precision lowp sampler2D;attribute vec2 a_pos;attribute vec2 a_tex_pos;varying vec2 vTexCoordCropped;varying vec2 vTexCoordFull;void main(void){gl_Position=vec4(a_pos,0,1);vTexCoordFull=(gl_Position*0.5+0.5).xy;vTexCoordCropped=a_tex_pos;}",fSrc:"#ifdef GL_FRAGMENT_PRECISION_HIGH\nprecision highp float;\n#else\nprecision mediump float;\n#endif\nprecision lowp int;precision lowp sampler2D;float atan2(float v1,float v2){if(v1==0.0||v2==0.0)return 0.0;return atan(v1,v2);}float _pow(float v1,float v2){if(v2==0.0)return 1.0;return pow(v1,v2);}float integerMod(float x,float y){float res=floor(mod(x,y));return res*(res>floor(y)-1.0 ? 0.0 : 1.0);}float divWithIntCheck(float x,float y){if(floor(x)==x&&floor(y)==y&&integerMod(x,y)==0.0){return float(int(x)/int(y));}return x/y;}float integerCorrectionModulo(float number,float divisor){if(number<0.0){number=abs(number);if(divisor<0.0){divisor=abs(divisor);}return-(number-(divisor*floor(divWithIntCheck(number,divisor))));}if(divisor<0.0){divisor=abs(divisor);}return number-(divisor*floor(divWithIntCheck(number,divisor)));}float getDEMElevationFromSampler2D(sampler2D tex,float x,float y){vec4 result=texture2D(tex,vec2(x,y));return(result.r*255.0*256.0+result.g*255.0)/5000.0;}float getDSMElevationFromSampler2D(sampler2D tex,float x,float y){vec4 result=texture2D(tex,vec2(x,y));return(result.b*255.0*256.0+result.a*255.0)/5000.0;}vec4 actualColor;void color(float r,float g,float b,float a){actualColor=vec4(r,g,b,a);}void color(float r,float g,float b){color(r,g,b,1.0);}void color(float r){color(r,r,r,1.0);}void color(vec4 color){actualColor=color;}const int LOOP_MAX=1000;varying vec2 vTexCoordCropped;varying vec2 vTexCoordFull;uniform sampler2D user_a;uniform float user_width;uniform float user_height;uniform float user_maxHeight;uniform float user_zoom;uniform float user_topYCoord;uniform float user_ySize;uniform vec4 user_color;uniform vec4 u_sunColor;uniform float user_step;uniform float user_west;uniform float user_dLng;uniform float user_dec;uniform float user_Hi;uniform bool u_below_canopy;uniform sampler2D user_sunExposureTexture;uniform bool user_renderToSunExposureTexture;uniform bool user_outputSunExposure;uniform vec4 user_exposureDelta;uniform bool u_outputShadeProfile;uniform sampler2D u_decHiTexture;uniform sampler2D u_gpxTexture;uniform bool u_outputLocationShadeProfile;uniform vec2 u_shadeProfileLocation;float kernelResult;void kernel(){float sunDec=user_dec;float sunHi=user_Hi;vec4 shade_color=user_color;float maxHeight=user_maxHeight/1000.0;float user_x=vTexCoordCropped.x;float user_y=vTexCoordCropped.y;if(u_outputShadeProfile==true){vec4 decHi=texture2D(u_decHiTexture,vec2(vTexCoordFull.x,1.0-vTexCoordFull.y));sunDec=-decHi.r;sunHi=decHi.g*10.0;vec4 gpx=texture2D(u_gpxTexture,vec2(vTexCoordFull.x,.5));user_x=gpx.x;user_y=gpx.y;}if(u_outputLocationShadeProfile==true){vec4 decHi=texture2D(u_decHiTexture,vec2(vTexCoordFull.x,1.0-vTexCoordFull.y));sunDec=-decHi.r;sunHi=decHi.g*10.0;user_x=u_shadeProfileLocation.x;user_y=u_shadeProfileLocation.y;}float user_lit=1.0;float dsm_height=getDSMElevationFromSampler2D(user_a,user_x,user_y);if(u_below_canopy==true){float dem_height=getDEMElevationFromSampler2D(user_a,user_x,user_y);if(dsm_height-dem_height>.002){user_lit=0.0;}}float user_z=dsm_height;float user_PI=3.141592653589793;float user_2PI=6.283185307179586;float earthRadiusInKm=6378.137;float user_deg=57.29577951308232;float user_y_coord=user_topYCoord+(user_y*user_ySize);float user_lat_coord=(user_y_coord-0.5)/-0.15915494309189532;float user_lat=(2.0*atan(exp(user_lat_coord)))-(user_PI/2.0);float user_rad=0.017453292519943295;float user_lng=user_west+(user_dLng*user_x);float user_H=integerCorrectionModulo((sunHi-(user_rad*-user_lng)),user_2PI);float sun_azimuth=atan2(sin(user_H),((cos(user_H)*sin(user_lat))-(tan(sunDec)*cos(user_lat))));float sun_altitude=asin(((sin(user_lat)*sin(sunDec))+((cos(user_lat)*cos(sunDec))*cos(user_H))));float user_zoom_factor=_pow(2.0,user_zoom);float user_kmPerPixel=divWithIntCheck(156.5430339296875,user_zoom_factor)*abs(cos(user_lat));float user_dx=((-sin(sun_azimuth)*cos(sun_altitude))*user_step)/user_width;float user_dy=((cos(sun_azimuth)*cos(sun_altitude))*user_step)/user_height;float user_dz=((sin(sun_altitude)*user_kmPerPixel)*user_step);float shadow_bias=0.0005;float user_curvature=0.0;float cur_height=0.0;float user_distance=0.0;float user_startX=user_x;float user_startY=user_y;user_x+=user_dx;user_y+=user_dy;user_z+=user_dz;if((abs(1.0)<0.0)){kernelResult=0.0;return;}float minAngle=asin((earthRadiusInKm/(earthRadiusInKm+user_z)))-(user_PI/2.0);if(user_z<0.0||sun_altitude<minAngle){user_lit=0.0;}else{float xIter=ceil(user_dx<0.0 ? abs(user_x/user_dx):(1.0-user_x)/user_dx);float yIter=ceil(user_dy<0.0 ? abs(user_y/user_dy):(1.0-user_y)/user_dy);float zIter=ceil(user_dz<0.0 ? float(LOOP_MAX):(maxHeight-user_z)/user_dz);int iter=int(min(xIter,min(yIter,zIter)));float user_distance=(sqrt(pow(user_dx*user_width,2.0)+pow(user_dy*user_height,2.0))*user_kmPerPixel)/earthRadiusInKm;for(int safeI=0;safeI<LOOP_MAX;safeI++){if(safeI>iter){break;}cur_height=getDSMElevationFromSampler2D(user_a,user_x,user_y);if(cur_height-user_z>shadow_bias){user_curvature=earthRadiusInKm*(1.0-cos(user_distance*float(safeI+1)));if(user_z<(cur_height-user_curvature)){user_lit=0.0;vec4 result=texture2D(user_a,vec2(user_x,user_y));iter=0;break;}}user_x+=user_dx;user_y+=user_dy;user_z+=user_dz;}}if((user_lit==1.0)){if(u_outputLocationShadeProfile==true&&u_sunColor==shade_color){float timeInSun=pow(.7,pow(sin(sun_altitude),.678))*sin(sun_altitude)*(1.0/0.7);float h=0.5;vec4 blue=vec4(0.0,0.0,1.0,1.0);vec4 green=vec4(0.0,1.0,0.0,1.0);vec4 red=vec4(1.0,0.0,0.0,1.0);vec4 col=mix(mix(blue,green,timeInSun/h),mix(green,red,(timeInSun-h)/(1.0-h)),step(h,timeInSun));color(col.r,col.g,col.b,1.0);}else{color(u_sunColor);}}else{color(shade_color);}if(user_renderToSunExposureTexture){vec4 aggregateColor=texture2D(user_sunExposureTexture,vec2(vTexCoordFull.x,vTexCoordFull.y));if((user_lit==1.0)){color(aggregateColor.r,0.0,0.0,1.0);}else{color(aggregateColor.r+user_exposureDelta.r,0.0,0.0,1.0);}if(user_outputSunExposure){float timeInSun=1.0-aggregateColor.r;float h=0.5;vec4 blue=vec4(0.0,0.0,1.0,1.0);vec4 green=vec4(0.0,1.0,0.0,1.0);vec4 red=vec4(1.0,0.0,0.0,1.0);vec4 col=mix(mix(blue,green,timeInSun/h),mix(green,red,(timeInSun-h)/(1.0-h)),step(h,timeInSun));color(col.r,col.g,col.b,0.5);}}}void main(void){kernel();gl_FragColor=actualColor;}"});i.useProgram(n);const o=i.createBuffer(),a=i.getAttribLocation(n,"a_pos"),s=i.createBuffer(),u=i.getAttribLocation(n,"a_tex_pos"),h=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,h),i.bufferData(i.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,1,1]),i.STATIC_DRAW);const l=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,l),i.bufferData(i.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,1,1]),i.STATIC_DRAW);const c=i.getUniformLocation(n,"user_a");i.uniform1i(c,0);const f=i.getUniformLocation(n,"user_width"),m=i.getUniformLocation(n,"user_height"),_=i.getUniformLocation(n,"user_maxHeight"),x=i.getUniformLocation(n,"user_zoom"),g=i.getUniformLocation(n,"user_topYCoord"),E=i.getUniformLocation(n,"user_ySize"),T=i.getUniformLocation(n,"user_step"),v=i.getUniformLocation(n,"user_west"),y=i.getUniformLocation(n,"user_dLng"),R=i.getUniformLocation(n,"user_dec"),A=i.getUniformLocation(n,"user_Hi"),b=i.getUniformLocation(n,"user_color"),M=i.getUniformLocation(n,"user_xStart"),w=i.getUniformLocation(n,"user_yStart"),F=i.getUniformLocation(n,"user_xEnd"),U=i.getUniformLocation(n,"user_yEnd"),D=i.getUniformLocation(n,"u_below_canopy"),L=i.getUniformLocation(n,"user_sunExposureTexture"),S=i.getUniformLocation(n,"user_renderToSunExposureTexture"),P=i.getUniformLocation(n,"user_outputSunExposure"),C=i.getUniformLocation(n,"user_exposureDelta"),I=i.getUniformLocation(n,"u_outputShadeProfile"),B=i.getUniformLocation(n,"u_gpxTexture"),N=i.getUniformLocation(n,"u_decHiTexture"),O=i.getUniformLocation(n,"u_sunColor"),X=i.getUniformLocation(n,"u_outputLocationShadeProfile"),G=i.getUniformLocation(n,"u_shadeProfileLocation");let z=0,H=0,W=0,j=null;const Z=()=>{H&&W&&(i.useProgram(n),i.bindBuffer(i.ARRAY_BUFFER,o),i.enableVertexAttribArray(a),i.vertexAttribPointer(a,2,i.FLOAT,!1,0,0),i.bindBuffer(i.ARRAY_BUFFER,s),i.enableVertexAttribArray(u),i.vertexAttribPointer(u,2,i.FLOAT,!1,0,0),null!==j&&(i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,j)),r(i,H,W),i.viewport(0,0,H,W),i.clear(i.COLOR_BUFFER_BIT),i.drawArrays(i.TRIANGLE_STRIP,0,4))};let Y=0;return{updateLocation:function(t){const{heightMapTex:e,width:r,height:a,maxHeight:u,heightMapZoom:h,topYCoord:l,ySize:c,colorVec:d,step:p,west:M,dLng:w,dec:F,Hi:U,cornerClipCoords:L,cornerTextureCoords:S,outputWidth:P,outputHeight:C,belowCanopy:I}=t;i.useProgram(n),H=P,W=C,j=e,i.bindBuffer(i.ARRAY_BUFFER,o),i.bufferData(i.ARRAY_BUFFER,new Float32Array(L),i.STATIC_DRAW),i.bindBuffer(i.ARRAY_BUFFER,s),i.bufferData(i.ARRAY_BUFFER,new Float32Array(S),i.STATIC_DRAW),i.uniform1f(f,r),i.uniform1f(m,a),i.uniform1f(_,u),i.uniform1f(x,h),i.uniform1f(g,l),i.uniform1f(E,c),i.uniform4fv(b,d),i.uniform1f(T,p),i.uniform1f(v,M),i.uniform1f(y,w),i.uniform1f(R,F),i.uniform1f(A,U),i.uniform1f(D,I?1:0),window.cancelAnimationFrame(z),z=window.requestAnimationFrame(Z)},updateViewport:function(t){const{xStart:e,yStart:r,xEnd:o,yEnd:a}=t;i.useProgram(n),i.uniform1f(M,e),i.uniform1f(w,r),i.uniform1f(F,o),i.uniform1f(U,a),window.cancelAnimationFrame(z),z=window.requestAnimationFrame(Z)},updateDate:t=>{const{dec:e,Hi:r}=t;i.useProgram(n),i.uniform1f(R,e),i.uniform1f(A,r),window.cancelAnimationFrame(z),z=window.requestAnimationFrame(Z)},updateDateRange:t=>p(this,void 0,void 0,(function*(){const{startDate:e,endDate:r,iterations:h,emit:l}=t;i.useProgram(n);const c=Y=Date.now();i.uniform4fv(C,new Float32Array([1/h,0,0,0]));const f=Math.floor((r.getTime()-e.getTime())/h),m=H,_=W,x=i.createTexture();i.activeTexture(i.TEXTURE1),i.bindTexture(i.TEXTURE_2D,x),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,m,_,0,i.RGBA,i.UNSIGNED_BYTE,null),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST);const g=i.createTexture();i.activeTexture(i.TEXTURE2),i.bindTexture(i.TEXTURE_2D,g),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,m,_,0,i.RGBA,i.UNSIGNED_BYTE,null),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST);const p=i.createFramebuffer();i.bindFramebuffer(i.FRAMEBUFFER,p);const E=i.COLOR_ATTACHMENT0;for(let t=0;t<h;t++){if(i.useProgram(n),l("tileloaded",t,h-1),c!==Y)return i.deleteFramebuffer(p),i.deleteTexture(x),i.deleteTexture(g),!0;yield new Promise(((r,h)=>{window.requestAnimationFrame((()=>{i.useProgram(n),i.uniform1i(L,1),i.uniform1i(S,1),null!==j&&(i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,j));const h=t%2==0?g:x,l=t%2==0?x:g;i.activeTexture(i.TEXTURE1),i.bindTexture(i.TEXTURE_2D,h),i.bindFramebuffer(i.FRAMEBUFFER,p),i.framebufferTexture2D(i.FRAMEBUFFER,E,i.TEXTURE_2D,l,0);const c=i.checkFramebufferStatus(i.FRAMEBUFFER);c!==i.FRAMEBUFFER_COMPLETE&&console.error("Framebuffer is incomplete: "+c);const{dec:T,Hi:v}=d(new Date(e.getTime()+f*t));i.uniform1f(R,T),i.uniform1f(A,v),i.bindBuffer(i.ARRAY_BUFFER,o),i.enableVertexAttribArray(a),i.vertexAttribPointer(a,2,i.FLOAT,!1,0,0),i.bindBuffer(i.ARRAY_BUFFER,s),i.enableVertexAttribArray(u),i.vertexAttribPointer(u,2,i.FLOAT,!1,0,0),i.viewport(0,0,m,_),i.clear(i.COLOR_BUFFER_BIT),i.drawArrays(i.TRIANGLE_STRIP,0,4),r()}))}))}return i.deleteFramebuffer(p),yield new Promise(((t,e)=>{window.requestAnimationFrame((()=>{if(i.useProgram(n),c!==Y)return i.deleteTexture(x),i.deleteTexture(g),void t(!0);i.activeTexture(i.TEXTURE2),i.bindTexture(i.TEXTURE_2D,(h-1)%2==0?x:g),i.uniform1i(L,2),i.uniform1i(P,1),i.uniform1i(S,1),Z(),i.uniform1i(S,0),i.uniform1i(P,0),i.uniform1i(L,0),i.deleteTexture(x),i.deleteTexture(g),t(!1)}))}))})),updateColor:t=>{const{colorVec:e}=t;i.useProgram(n),i.uniform4fv(b,e),window.cancelAnimationFrame(z),z=window.requestAnimationFrame(Z)},generateShadeProfile:t=>{i.useProgram(n);const{dates:e,texCoords:r,shadeColor:o,sunColor:s}=t,c=r.length,f=e.length,m=i.getUniform(n,b);i.uniform4fv(b,o),i.uniform4fv(O,s),i.uniform1i(I,1);const _=i.createTexture();i.activeTexture(i.TEXTURE3),rt({gl:i,imageData:null,width:c,height:f,wrap:i.CLAMP_TO_EDGE,filter:i.NEAREST,format:i.RGBA,texture:_});const x=i.createFramebuffer();i.bindFramebuffer(i.FRAMEBUFFER,x),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,_,0);const g=i.checkFramebufferStatus(i.FRAMEBUFFER);g!==i.FRAMEBUFFER_COMPLETE&&console.error("Framebuffer is incomplete: "+g);const p=r.map((t=>[t[0],t[1],0,0])).flat(),E=i.createTexture();i.activeTexture(i.TEXTURE2),rt({gl:i,texture:E,imageData:new Float32Array(p),width:p.length/4,height:1,wrap:i.CLAMP_TO_EDGE,filter:i.NEAREST,format:i.RGBA,internalFormat:i.RGBA32F,type:i.FLOAT}),i.uniform1i(B,2);const T=e.map((t=>{const{dec:e,Hi:r}=d(t);return[-e,r/10,0,0]})).flat(),v=i.createTexture();i.activeTexture(i.TEXTURE1),rt({gl:i,texture:v,imageData:new Float32Array(T),width:1,height:e.length,wrap:i.CLAMP_TO_EDGE,filter:i.NEAREST,format:i.RGBA,internalFormat:i.RGBA32F,type:i.FLOAT}),i.uniform1i(N,1),null!==j&&(i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,j)),i.bindBuffer(i.ARRAY_BUFFER,h),i.enableVertexAttribArray(a),i.vertexAttribPointer(a,2,i.FLOAT,!1,0,0),i.bindBuffer(i.ARRAY_BUFFER,l),i.enableVertexAttribArray(u),i.vertexAttribPointer(u,2,i.FLOAT,!1,0,0),i.viewport(0,0,c,f),i.clear(i.COLOR_BUFFER_BIT),i.drawArrays(i.TRIANGLE_STRIP,0,4);const y=new Uint8Array(c*f*4);return i.readPixels(0,0,c,f,i.RGBA,i.UNSIGNED_BYTE,y),i.deleteTexture(_),i.deleteTexture(v),i.deleteTexture(E),i.deleteFramebuffer(x),i.uniform1i(N,0),i.uniform1i(B,0),i.uniform1i(I,0),i.uniform4fv(b,m),i.uniform4fv(O,[0,0,0,0]),y},generateLocationShadeProfile:t=>{i.useProgram(n);const{dates:e,texCoord:r,shadeColor:o,sunColor:s}=t,c=e[0].length,f=e.length,m=i.getUniform(n,b);i.uniform4fv(b,o),i.uniform4fv(O,s),i.uniform1i(X,1),i.uniform2fv(G,[r[0],r[1]]);const _=i.createTexture();i.activeTexture(i.TEXTURE2),rt({gl:i,imageData:null,width:c,height:f,wrap:i.CLAMP_TO_EDGE,filter:i.NEAREST,format:i.RGBA,texture:_});const x=i.createFramebuffer();i.bindFramebuffer(i.FRAMEBUFFER,x),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,_,0);const g=i.checkFramebufferStatus(i.FRAMEBUFFER);g!==i.FRAMEBUFFER_COMPLETE&&console.error("Framebuffer is incomplete: "+g);const p=e.flat().map((t=>{const{dec:e,Hi:r}=d(t);return[-e,r/10,0,0]})).flat(),E=i.createTexture();i.activeTexture(i.TEXTURE1),rt({gl:i,texture:E,imageData:new Float32Array(p),width:c,height:f,wrap:i.CLAMP_TO_EDGE,filter:i.NEAREST,format:i.RGBA,internalFormat:i.RGBA32F,type:i.FLOAT}),i.uniform1i(N,1),null!==j&&(i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,j)),i.uniform1i(S,0),i.bindBuffer(i.ARRAY_BUFFER,h),i.enableVertexAttribArray(a),i.vertexAttribPointer(a,2,i.FLOAT,!1,0,0),i.bindBuffer(i.ARRAY_BUFFER,l),i.enableVertexAttribArray(u),i.vertexAttribPointer(u,2,i.FLOAT,!1,0,0),i.viewport(0,0,c,f),i.clear(i.COLOR_BUFFER_BIT),i.drawArrays(i.TRIANGLE_STRIP,0,4);const T=new Uint8Array(c*f*4);return i.readPixels(0,0,c,f,i.RGBA,i.UNSIGNED_BYTE,T),i.deleteTexture(_),i.deleteTexture(E),i.deleteFramebuffer(x),i.uniform1i(N,0),i.uniform1i(X,0),i.uniform4fv(b,m),i.uniform4fv(O,[0,0,0,0]),T}}}({context:this._gl,setRenderBuffer:(e,r,i)=>{const n=t.getSource(this.canvasSourceId).texture;e.activeTexture(e.TEXTURE1),n.bind(e.LINEAR,e.CLAMP_TO_EDGE),n.size=[r,i],e.texImage2D(e.TEXTURE_2D,0,e.RGBA,r,i,0,e.RGBA,e.UNSIGNED_BYTE,null),e.bindFramebuffer(e.FRAMEBUFFER,this._framebuffer),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,n.texture,0),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA)}}),this._tileMerger=new at(this._gl),this._buildingRasterizer=new nt(this._gl),document.body.appendChild(this._canvas),this._canvas.style.display="none";const e=t.getBounds(),r=e.getNorthWest(),i=e.getNorthEast(),n=e.getSouthEast(),o=e.getSouthWest(),a=[[r.lng,r.lat],[i.lng,i.lat],[n.lng,n.lat],[o.lng,o.lat]];return t.addSource(this.canvasSourceId,{type:"canvas",canvas:this._canvas,coordinates:a,animate:!1}),t.addLayer({id:this.canvasLayerId,type:"raster",source:this.canvasSourceId,paint:{"raster-fade-duration":0}}),t.addSource(this.attributionSourceId,{type:"geojson",data:{type:"Feature",properties:{},geometry:{type:"Point",coordinates:[-122.210598,47.769799]}},attribution:'<a href="https://shademap.app/about">&copy; ShadeMap</a>'}),t.addLayer({id:this.attributionLayerId,type:"fill",source:this.attributionSourceId}),this._map.on("moveend",this._moveEndHandler),this._moveEndHandler(),this}onRemove(){return this._map&&(this._map.off("moveend",this._moveEndHandler),this._map.removeLayer(this.attributionLayerId),this._map.removeLayer(this.canvasLayerId),this._map.removeSource(this.attributionSourceId),this._map.removeSource(this.canvasSourceId)),this._gl&&this._framebuffer&&this._gl.deleteFramebuffer(this._framebuffer),document.body.removeChild(this._canvas),this.options.debug("onRemove called"),this}_getHeightMapCoords(t,e){if(this._map&&this.options.sunExposure.enabled&&this._bounds&&this._heightMap){const r=this._map.unproject([t,e]);if(r.toString()===this._map.unproject([t,e+1]).toString())return new i(-1,-1);const{visibleDEMPixelBounds:n,demZoom:o}=this._heightMap;return g(this._map).project(r,o).subtract(n.min)}return new i(-1,-1)}getHoursOfSun(t,e){if(this.options.sunExposure.enabled){const r=this._getHeightMapCoords(t,e),i=this.readPixel(r.x,r.y),{startDate:n,endDate:o}=this.options.sunExposure,a=o.getTime()-n.getTime(),s=_(i,.5,a);return Math.abs(s/1e3/3600)}return 0}remove(){this._map&&this._map.removeLayer(this.id)}readPixel(t,e){const r=new Uint8Array(4);if(this._map&&this._gl&&this._framebuffer){const i=this._gl,n=this._map.getSource(this.canvasSourceId).texture;i.activeTexture(i.TEXTURE1),n.bind(i.LINEAR,i.CLAMP_TO_EDGE),i.bindFramebuffer(i.FRAMEBUFFER,this._framebuffer),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,n.texture,0),this._gl.readPixels(t,e,1,1,this._gl.RGBA,this._gl.UNSIGNED_BYTE,r)}return r}readPixels(t,e,r,i){console.log("Reading pix",t,e,r,i);const n=new Uint8Array(r*i*4);if(this._map&&this._gl&&this._framebuffer){const o=this._gl,a=this._map.getSource(this.canvasSourceId).texture;o.activeTexture(o.TEXTURE1),a.bind(o.LINEAR,o.CLAMP_TO_EDGE),o.bindFramebuffer(o.FRAMEBUFFER,this._framebuffer),o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,a.texture,0),this._gl.readPixels(t,e,r,i,this._gl.RGBA,this._gl.UNSIGNED_BYTE,n)}return n}_flush(){if(this._map){this._map.getSource(this.canvasSourceId).fire({type:"data",dataType:"source",sourceDataType:"content"})}this.emit("idle")}_repositionCanvas(t){if(this._map){const e=this._map.getSource(this.canvasSourceId);if(e){const r=t.getNorthWest(),i=t.getNorthEast(),n=t.getSouthEast(),o=t.getSouthWest(),a=[[r.lng,r.lat],[i.lng,i.lat],[n.lng,n.lat],[o.lng,o.lat]];e.setCoordinates(a),this.emit("idle")}}return this}}export{st as default};
