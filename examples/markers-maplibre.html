<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@5.9.0/dist/maplibre-gl.css" />
  <script src="https://unpkg.com/maplibre-gl@5.9.0/dist/maplibre-gl.js"></script>
  <script src="https://www.unpkg.com/suncalc@1.9.0/suncalc.js"></script>
  <script src="https://unpkg.com/protomaps-themes-base@4.5.0/dist/protomaps-themes-base.js"></script>
  <script src="../dist/mapbox-gl-shadow-simulator.umd.min.js"></script>
  <style>
    body {
      padding: 0px;
      margin: 0px;
    }

    #mapid {
      height: 100vh;
    }

    .maplibregl-control-time {
      padding: 20px;
      background-color: white;
    }
  </style>
  <title>mapbox-gl-shadow-simulator Maplibre Markers Example</title>
</head>

<body>
  <div id="mapid">
    <div class="maplibregl-control-container" style="z-index: 2000; pointer-events: auto">
      <div class="maplibregl-ctrl-top-left">
        <div class="maplibregl-control-time" style="pointer-events: auto">
          <button id="decrement">-1 hour</button>
          <button id="increment">+1 hour</button>
          <button id="play">Play</button>
          <button id="stop">Stop</button>
          <button>
            <a href="https://shademap.app/about" target="_blank">Get API key</a>
          </button>
          <span id="loader" style="padding: 3px"></span>
        </div>
      </div>
    </div>
  </div>
  <script>
    const mapLoaded = (map) => {
      return new Promise((res, rej) => {
        function cb() {
          if (!map.loaded()) {
            return;
          }
          map.off("render", cb);
          res();
        }
        map.on("render", cb);
        cb();
      });
    };
    /* Maplibregl setup */
    maplibregl.setRTLTextPlugin(
      "https://unpkg.com/@mapbox/mapbox-gl-rtl-text@0.2.3/mapbox-gl-rtl-text.min.js",
      true // Lazy load the plugin
    );

    const map = new maplibregl.Map({
      container: "mapid",
      style: {
        version: 8,
        glyphs:
          "https://protomaps.github.io/basemaps-assets/fonts/{fontstack}/{range}.pbf",
        sources: {
          protomaps: {
            type: "vector",
            tiles: ["https://cfw.shademap.app/planet/{z}/{x}/{y}.pbf"],
            attribution:
              '<a href="https://protomaps.com">Protomaps</a> Â© <a href="https://openstreetmap.org">OpenStreetMap</a>',
            maxzoom: 15,
          },
          buildings: {
            type: "vector",
            tiles: [`https://cfw.shademap.app/buildings/{z}/{x}/{y}.mvt`],
            minzoom: 14,
            maxzoom: 14,
          },
        },
        layers: [
          ...protomaps_themes_base.default("protomaps", "light", "en"),
          {
            id: "building",
            source: "buildings",
            "source-layer": "building",
            type: "line",
          },
        ],
      },
      maplibreLogo: true,
      center: { lng: -122.15675711631776, lat: 47.75510439397995 },
      zoom: 16, // starting zoom
      hash: true,
    });
    /* End Maplibregl setup */

    /* Add markers for cafes */
    const cafes = [
      { lat: 47.75479062611596, lng: -122.15534138695534 },
      { lat: 47.75337697202738, lng: -122.16319480178332 },
      { lat: 47.751941595291726, lng: -122.15921456808333 },
      { lat: 47.753477542718706, lng: -122.15083544800348 },
      { lat: 47.754992309138885, lng: -122.15102829347933 },
      { lat: 47.757776865447056, lng: -122.1563603726317 },
    ];
    const markers = cafes.map((coords) => {
      return new maplibregl.Marker().setLngLat(coords).addTo(map);
    });
    /* End add markers for cafes */

    /* ShadeMap setup */
    const loaderEl = document.getElementById("loader");
    let now = new Date(1633362188054);
    let shadeMap;
    map.on("load", () => {
      shadeMap = new ShadeMap({
        apiKey:
          "eyJhbGciOiJIUzI1NiJ9.eyJlbWFpbCI6InRwcGlvdHJvd3NraUBzaGFkZW1hcC5hcHAiLCJjcmVhdGVkIjoxNjYyNDkzMDY2Nzk0LCJpYXQiOjE2NjI0OTMwNjZ9.ovCrLTYsdKFTF6TW3DuODxCaAtGQ3qhcmqj3DWcol5g",
        date: now,
        color: "#01112f",
        opacity: 0.7,
        terrainSource: {
          maxZoom: 15,
          tileSize: 256,
          getSourceUrl: ({ x, y, z }) =>
            `https://s3.amazonaws.com/elevation-tiles-prod/terrarium/${z}/${x}/${y}.png`,
          getElevation: ({ r, g, b, a }) => r * 256 + g + b / 256 - 32768,
          _overzoom: 18,
        },
        getFeatures: async () => {
          if (map.getZoom() >= 12) {
            await mapLoaded(map);
            const buildingData = map.querySourceFeatures("buildings", {
              sourceLayer: "building",
            });

            buildingData.forEach((feature) => {
              feature.properties.height = feature.properties.height || 3.1;
            });

            // Buildings segments must be rasterized from bottom to top. If not, the base of a building
            // could rasterize over the top tower of the building
            buildingData.sort((a, b) => {
              return a.properties.height - b.properties.height;
            });
            return buildingData;
          }
          return [];
        },
        debug: (msg) => {
          console.log(new Date().toISOString(), msg);
        },
      }).addTo(map);

      shadeMap.on("tileloaded", (loadedTiles, totalTiles) => {
        loaderEl.innerText = `Loading: ${(
          (loadedTiles / totalTiles) *
          100
        ).toFixed(0)}%`;
      });

      shadeMap.on("idle", async () => {
        console.log('idle')
        const promises = markers.map((marker) => {
          const latlng = marker.getLngLat();
          const { x, y } = map.project(latlng);
          return shadeMap.isPositionInSun(x, y);
        });
        const results = await Promise.all(promises);
        markers.forEach((marker, i) => {
          const inTheSun = results[i] === true;
          const element = marker.getElement();
          const svg = element.getElementsByTagName("svg")[0];
          const path = svg.getElementsByTagName("path")[0];
          path.setAttribute("fill", inTheSun ? "#ffcc00" : "#ccf");
        });
      });
    });
    /* End ShadeMap setup */

    /* Controls setup */
    let intervalTimer;

    const increment = document.getElementById("increment");
    const decrement = document.getElementById("decrement");
    const play = document.getElementById("play");
    const stop = document.getElementById("stop");

    increment.addEventListener(
      "click",
      () => {
        now = new Date(now.getTime() + 3600000);
        shadeMap && shadeMap.setDate(now);
      },
      false
    );

    decrement.addEventListener(
      "click",
      () => {
        now = new Date(now.getTime() - 3600000);
        shadeMap && shadeMap.setDate(now);
      },
      false
    );

    play.addEventListener("click", () => {
      intervalTimer = setInterval(() => {
        now = new Date(now.getTime() + 60000);
        shadeMap && shadeMap.setDate(now);
      }, 100);
    });

    stop.addEventListener("click", () => {
      clearInterval(intervalTimer);
    });
    /* End controls setup */
  </script>
</body>

</html>